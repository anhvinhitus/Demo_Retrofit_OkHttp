stages:
  - build
  - test
  - archive
  - deploy

before_script:
  - export ANDROID_HOME=/ci/android-sdk
  - export ANDROID_NDK_HOME=/ci/android-ndk-r12b
  - export CI_BUILD=$CI_SERVER
  - export CI_BUILD_TAG=$CI_BUILD_TAG
  - mkdir -p ./releases

build:
  stage: build
  except:
    - tags  
  script:
    - cd ZaloPay && ./gradlew --no-daemon --max-workers=3 assembleProductionDebug

test:
  stage: test
  except:
    - tags
  script:
    - cd ZaloPay && ./gradlew --no-daemon --max-workers=3 testProductionDebugUnitTest :zalopay.data:testDebugUnitTest

archive:
  stage: archive
  script:
    - cd ZaloPay && ./gradlew --no-daemon --max-workers=3 clean assembleProductionRelease assembleStagingRelease assembleSandboxRelease
  only:
    - tags
  artifacts:
    name: $CI_BUILD_STAGE_$CI_BUILD_TAG
    expire_in: 4 week
    paths:
      - releases/ZaloPay-sandbox-release-$CI_BUILD_TAG.apk
      - releases/ZaloPay-staging-release-$CI_BUILD_TAG.apk
      - releases/ZaloPay-production-release-$CI_BUILD_TAG.apk

deploy_fabric:
  stage: deploy
  script:
    - shopt -s expand_aliases
    - alias sandbox='git log --oneline -n 1 | grep -E "\[Sandbox\] Bump version"'
    - alias staging='git log --oneline -n 1 | grep -E "\[Staging\] Bump version"'
    - alias production='git log --oneline -n 1 | grep -E "\[Production\] Bump version"'
    - sandbox || staging || production || (echo "No need to deploy to fabric" && exit 0)
    - sandbox && cd ZaloPay && ./deploy.sh sandbox
    - staging && cd ZaloPay && ./deploy.sh staging
    - production && cd ZaloPay && ./deploy.sh production
    - exit 0

